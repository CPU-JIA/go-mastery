// ğŸš€ ç”¨æˆ·æœåŠ¡ Protoå®šä¹‰ - ç°ä»£åŒ–gRPCæ¥å£è®¾è®¡
syntax = "proto3";

package user_service.v1;

option go_package = "github.com/go-mastery/microservices/grpc/user/v1;userv1";

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/field_mask.proto";

// ç”¨æˆ·æœåŠ¡æ¥å£å®šä¹‰
service UserService {
  // åˆ›å»ºç”¨æˆ·
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);

  // è·å–ç”¨æˆ·ä¿¡æ¯
  rpc GetUser(GetUserRequest) returns (GetUserResponse);

  // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
  rpc UpdateUser(UpdateUserRequest) returns (UpdateUserResponse);

  // åˆ é™¤ç”¨æˆ·
  rpc DeleteUser(DeleteUserRequest) returns (google.protobuf.Empty);

  // åˆ—å‡ºç”¨æˆ· (æ”¯æŒåˆ†é¡µ)
  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);

  // æ‰¹é‡è·å–ç”¨æˆ·
  rpc BatchGetUsers(BatchGetUsersRequest) returns (BatchGetUsersResponse);

  // ç”¨æˆ·è®¤è¯
  rpc AuthenticateUser(AuthenticateUserRequest) returns (AuthenticateUserResponse);

  // æµå¼æ¥å£ - ç”¨æˆ·æ´»åŠ¨æµ
  rpc StreamUserActivity(StreamUserActivityRequest) returns (stream UserActivityEvent);

  // åŒå‘æµ - ç”¨æˆ·èŠå¤©
  rpc UserChat(stream ChatMessage) returns (stream ChatMessage);

  // å¥åº·æ£€æŸ¥
  rpc HealthCheck(google.protobuf.Empty) returns (HealthCheckResponse);
}

// ç”¨æˆ·æ¨¡å‹
message User {
  string user_id = 1;
  string username = 2;
  string email = 3;
  string full_name = 4;
  string phone_number = 5;
  UserStatus status = 6;
  repeated string roles = 7;
  map<string, string> metadata = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
}

// ç”¨æˆ·çŠ¶æ€æšä¸¾
enum UserStatus {
  USER_STATUS_UNSPECIFIED = 0;
  USER_STATUS_ACTIVE = 1;
  USER_STATUS_INACTIVE = 2;
  USER_STATUS_SUSPENDED = 3;
  USER_STATUS_DELETED = 4;
}

// åˆ›å»ºç”¨æˆ·è¯·æ±‚
message CreateUserRequest {
  string username = 1;
  string email = 2;
  string password = 3;
  string full_name = 4;
  string phone_number = 5;
  repeated string roles = 6;
  map<string, string> metadata = 7;
}

// åˆ›å»ºç”¨æˆ·å“åº”
message CreateUserResponse {
  User user = 1;
  string access_token = 2;
  string refresh_token = 3;
}

// è·å–ç”¨æˆ·è¯·æ±‚
message GetUserRequest {
  oneof identifier {
    string user_id = 1;
    string username = 2;
    string email = 3;
  }
  google.protobuf.FieldMask field_mask = 4; // å­—æ®µæ©ç ï¼Œæ”¯æŒéƒ¨åˆ†å­—æ®µæŸ¥è¯¢
}

// è·å–ç”¨æˆ·å“åº”
message GetUserResponse {
  User user = 1;
}

// æ›´æ–°ç”¨æˆ·è¯·æ±‚
message UpdateUserRequest {
  string user_id = 1;
  User user = 2;
  google.protobuf.FieldMask update_mask = 3;
}

// æ›´æ–°ç”¨æˆ·å“åº”
message UpdateUserResponse {
  User user = 1;
}

// åˆ é™¤ç”¨æˆ·è¯·æ±‚
message DeleteUserRequest {
  string user_id = 1;
  bool hard_delete = 2; // æ˜¯å¦ç¡¬åˆ é™¤
}

// åˆ—å‡ºç”¨æˆ·è¯·æ±‚
message ListUsersRequest {
  int32 page_size = 1;
  string page_token = 2;
  UserFilter filter = 3;
  repeated string order_by = 4;
}

// ç”¨æˆ·è¿‡æ»¤å™¨
message UserFilter {
  repeated UserStatus statuses = 1;
  repeated string roles = 2;
  google.protobuf.Timestamp created_after = 3;
  google.protobuf.Timestamp created_before = 4;
  string search_query = 5; // æ”¯æŒæ¨¡ç³Šæœç´¢
}

// åˆ—å‡ºç”¨æˆ·å“åº”
message ListUsersResponse {
  repeated User users = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

// æ‰¹é‡è·å–ç”¨æˆ·è¯·æ±‚
message BatchGetUsersRequest {
  repeated string user_ids = 1;
  google.protobuf.FieldMask field_mask = 2;
}

// æ‰¹é‡è·å–ç”¨æˆ·å“åº”
message BatchGetUsersResponse {
  map<string, User> users = 1;
  repeated string not_found = 2;
}

// ç”¨æˆ·è®¤è¯è¯·æ±‚
message AuthenticateUserRequest {
  oneof credential {
    UsernamePasswordCredential username_password = 1;
    TokenCredential token = 2;
    OAuth2Credential oauth2 = 3;
  }
  string client_id = 4;
  string client_ip = 5;
  string user_agent = 6;
}

// ç”¨æˆ·åå¯†ç å‡­è¯
message UsernamePasswordCredential {
  string username = 1;
  string password = 2;
}

// Tokenå‡­è¯
message TokenCredential {
  string token = 1;
  string token_type = 2; // JWT, API_KEY, etc.
}

// OAuth2å‡­è¯
message OAuth2Credential {
  string provider = 1;
  string authorization_code = 2;
  string redirect_uri = 3;
}

// ç”¨æˆ·è®¤è¯å“åº”
message AuthenticateUserResponse {
  User user = 1;
  AuthTokens tokens = 2;
  AuthSession session = 3;
}

// è®¤è¯ä»¤ç‰Œ
message AuthTokens {
  string access_token = 1;
  string refresh_token = 2;
  string token_type = 3;
  int64 expires_in = 4;
  repeated string scopes = 5;
}

// è®¤è¯ä¼šè¯
message AuthSession {
  string session_id = 1;
  google.protobuf.Timestamp expires_at = 2;
  map<string, string> metadata = 3;
}

// æµå¼ç”¨æˆ·æ´»åŠ¨è¯·æ±‚
message StreamUserActivityRequest {
  string user_id = 1;
  repeated ActivityType activity_types = 2;
}

// æ´»åŠ¨ç±»å‹æšä¸¾
enum ActivityType {
  ACTIVITY_TYPE_UNSPECIFIED = 0;
  ACTIVITY_TYPE_LOGIN = 1;
  ACTIVITY_TYPE_LOGOUT = 2;
  ACTIVITY_TYPE_PROFILE_UPDATE = 3;
  ACTIVITY_TYPE_PASSWORD_CHANGE = 4;
  ACTIVITY_TYPE_ROLE_CHANGE = 5;
}

// ç”¨æˆ·æ´»åŠ¨äº‹ä»¶
message UserActivityEvent {
  string event_id = 1;
  string user_id = 2;
  ActivityType activity_type = 3;
  map<string, string> details = 4;
  google.protobuf.Timestamp timestamp = 5;
  string client_ip = 6;
  string user_agent = 7;
}

// èŠå¤©æ¶ˆæ¯
message ChatMessage {
  string message_id = 1;
  string from_user_id = 2;
  string to_user_id = 3;
  string content = 4;
  MessageType message_type = 5;
  google.protobuf.Timestamp timestamp = 6;
  map<string, string> metadata = 7;
}

// æ¶ˆæ¯ç±»å‹æšä¸¾
enum MessageType {
  MESSAGE_TYPE_UNSPECIFIED = 0;
  MESSAGE_TYPE_TEXT = 1;
  MESSAGE_TYPE_IMAGE = 2;
  MESSAGE_TYPE_FILE = 3;
  MESSAGE_TYPE_SYSTEM = 4;
}

// å¥åº·æ£€æŸ¥å“åº”
message HealthCheckResponse {
  HealthStatus status = 1;
  string message = 2;
  map<string, string> details = 3;
  google.protobuf.Timestamp timestamp = 4;
}

// å¥åº·çŠ¶æ€æšä¸¾
enum HealthStatus {
  HEALTH_STATUS_UNSPECIFIED = 0;
  HEALTH_STATUS_SERVING = 1;
  HEALTH_STATUS_NOT_SERVING = 2;
  HEALTH_STATUS_SERVICE_UNKNOWN = 3;
}