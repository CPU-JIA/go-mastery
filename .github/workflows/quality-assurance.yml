# ğŸ›¡ï¸ Go Mastery é¡¹ç›® - é›¶å®‰å…¨æ¼æ´è´¨é‡ä¿éšœ CI/CD æµæ°´çº¿
# è®¾è®¡ç›®æ ‡: ç»´æŠ¤ä¼ä¸šçº§é›¶å®‰å…¨è­¦å‘Šæ ‡å‡†
# æœ€åæ›´æ–°: 2025å¹´1æœˆ27æ—¥

name: ğŸ”’ Quality Assurance - Zero Security Warnings

# è§¦å‘æ¡ä»¶: å…¨é¢è¦†ç›–æ‰€æœ‰è´¨é‡ç›¸å…³äº‹ä»¶
on:
  # ä¸»è¦è§¦å‘æ¡ä»¶
  push:
    branches: [ main, develop, 'feature/*', 'security/*' ]
  pull_request:
    branches: [ main, develop ]

  # å®šæœŸè´¨é‡æ£€æŸ¥ (æ¯æ—¥UTC 02:00, åŒ—äº¬æ—¶é—´10:00)
  schedule:
    - cron: '0 2 * * *'

  # æ‰‹åŠ¨è§¦å‘è´¨é‡æ£€æŸ¥
  workflow_dispatch:
    inputs:
      check_level:
        description: 'è´¨é‡æ£€æŸ¥çº§åˆ«'
        required: true
        default: 'standard'
        type: choice
        options:
        - quick
        - standard
        - comprehensive
        - security-focused

# ç¯å¢ƒå˜é‡é…ç½®
env:
  GO_VERSION: '1.24'
  GOLANGCI_LINT_VERSION: 'v1.64.8'
  GOSEC_VERSION: 'v2.21.4'

  # è´¨é‡æ ‡å‡†é˜ˆå€¼
  SECURITY_VULNERABILITIES_THRESHOLD: 0  # é›¶å®‰å…¨æ¼æ´è¦æ±‚
  GO_VET_WARNINGS_THRESHOLD: 0          # é›¶Go vetè­¦å‘Šè¦æ±‚
  COVERAGE_THRESHOLD: 60                 # æµ‹è¯•è¦†ç›–ç‡æœ€ä½è¦æ±‚

jobs:
  # ===== P0çº§åˆ«: å®‰å…¨æ¼æ´æ£€æµ‹ (å…³é”®ä»»åŠ¡) =====
  security-scan:
    name: ğŸ›¡ï¸ P0-å®‰å…¨æ¼æ´æ‰«æ (é›¶æ¼æ´è¦æ±‚)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”§ è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ“‹ Goç¯å¢ƒè¯Šæ–­
      run: |
        echo "=== Goç¯å¢ƒä¿¡æ¯ ==="
        go version
        go env GOROOT
        go env GOPATH
        echo "==================="

    - name: ğŸ“¦ å®‰è£…gosecå®‰å…¨æ‰«æå™¨
      run: |
        curl -sfL https://raw.githubusercontent.com/securego/gosec/master/install.sh | sh -s -- -b $(go env GOPATH)/bin ${{ env.GOSEC_VERSION }}
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: ğŸ” æ‰§è¡Œå®‰å…¨æ¼æ´æ‰«æ
      run: |
        echo "ğŸš¨ å¼€å§‹å®‰å…¨æ¼æ´æ‰«æ..."

        # åˆ›å»ºå®‰å…¨æ‰«ææŠ¥å‘Šç›®å½•
        mkdir -p reports/security

        # æ‰§è¡Œgosecæ‰«æ (JSONæ ¼å¼è¾“å‡º)
        gosec -fmt json -out reports/security/gosec-report.json ./... || GOSEC_EXIT_CODE=$?

        # æ‰§è¡Œgosecæ‰«æ (æ–‡æœ¬æ ¼å¼è¾“å‡º)
        gosec -fmt text -out reports/security/gosec-report.txt ./... || true

        # åˆ†ææ‰«æç»“æœ
        if [ -f reports/security/gosec-report.json ]; then
          VULNERABILITY_COUNT=$(jq '.Stats.found' reports/security/gosec-report.json 2>/dev/null || echo "unknown")
          echo "ğŸ” å‘ç°å®‰å…¨æ¼æ´æ•°é‡: $VULNERABILITY_COUNT"

          if [ "$VULNERABILITY_COUNT" = "0" ]; then
            echo "âœ… å®‰å…¨æ‰«æé€šè¿‡: é›¶å®‰å…¨æ¼æ´çŠ¶æ€ç»´æŒ"
            echo "SECURITY_STATUS=PASS" >> $GITHUB_ENV
          elif [ "$VULNERABILITY_COUNT" != "unknown" ] && [ "$VULNERABILITY_COUNT" -gt 0 ]; then
            echo "âŒ å®‰å…¨æ‰«æå¤±è´¥: å‘ç° $VULNERABILITY_COUNT ä¸ªå®‰å…¨æ¼æ´"
            echo "SECURITY_STATUS=FAIL" >> $GITHUB_ENV
            echo "VULNERABILITY_COUNT=$VULNERABILITY_COUNT" >> $GITHUB_ENV

            # è¾“å‡ºæ¼æ´è¯¦æƒ…
            echo "=== å®‰å…¨æ¼æ´è¯¦æƒ… ==="
            cat reports/security/gosec-report.txt
            echo "====================="
          else
            echo "âš ï¸ æ— æ³•è§£æå®‰å…¨æ‰«æç»“æœ"
            echo "SECURITY_STATUS=ERROR" >> $GITHUB_ENV
          fi
        else
          echo "âŒ å®‰å…¨æ‰«ææŠ¥å‘Šç”Ÿæˆå¤±è´¥"
          echo "SECURITY_STATUS=ERROR" >> $GITHUB_ENV
        fi

    - name: ğŸ“Š ä¸Šä¼ å®‰å…¨æ‰«ææŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-reports
        path: reports/security/
        retention-days: 30

    - name: ğŸš¨ å®‰å…¨æ‰«æç»“æœéªŒè¯
      run: |
        if [ "$SECURITY_STATUS" = "FAIL" ]; then
          echo "ğŸ’¥ CIå¤±è´¥: æ£€æµ‹åˆ°å®‰å…¨æ¼æ´ï¼Œè¿åé›¶å®‰å…¨æ¼æ´è¦æ±‚"
          echo "ğŸ“‹ è¯·ç«‹å³ä¿®å¤ä»¥ä¸‹å®‰å…¨æ¼æ´:"
          echo "   1. æŸ¥çœ‹ä¸Šä¼ çš„å®‰å…¨æ‰«ææŠ¥å‘Š"
          echo "   2. å‚è€ƒ COMPREHENSIVE_QUALITY_REPORT.md ä¸­çš„ä¿®å¤ç­–ç•¥"
          echo "   3. è¿è¡Œ golangci-lint run è¿›è¡Œæœ¬åœ°éªŒè¯"
          exit 1
        elif [ "$SECURITY_STATUS" = "ERROR" ]; then
          echo "âš ï¸ CIè­¦å‘Š: å®‰å…¨æ‰«æè¿‡ç¨‹å‡ºç°é”™è¯¯"
          exit 1
        else
          echo "âœ… å®‰å…¨æ‰«æé€šè¿‡: é›¶å®‰å…¨æ¼æ´çŠ¶æ€å·²ç»´æŒ"
        fi

  # ===== P1çº§åˆ«: Goå®˜æ–¹å·¥å…·éªŒè¯ =====
  go-official-validation:
    name: ğŸ”§ P1-Goå®˜æ–¹å·¥å…·éªŒè¯
    runs-on: ubuntu-latest
    needs: security-scan
    timeout-minutes: 10

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”§ è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ” Go vetæ£€æŸ¥
      run: |
        echo "ğŸ” æ‰§è¡ŒGo vetæ£€æŸ¥..."
        go vet ./... 2>&1 | tee vet-output.txt

        if [ -s vet-output.txt ]; then
          echo "âŒ Go vetæ£€æŸ¥å¤±è´¥"
          echo "VET_STATUS=FAIL" >> $GITHUB_ENV
          echo "=== Go vet è­¦å‘Šè¯¦æƒ… ==="
          cat vet-output.txt
          echo "======================="
        else
          echo "âœ… Go vetæ£€æŸ¥é€šè¿‡"
          echo "VET_STATUS=PASS" >> $GITHUB_ENV
        fi

    - name: ğŸ—ï¸ Go buildéªŒè¯
      run: |
        echo "ğŸ—ï¸ æ‰§è¡ŒGo buildéªŒè¯..."

        # å°è¯•æ„å»ºæ‰€æœ‰åŒ…
        if go build ./...; then
          echo "âœ… Go buildéªŒè¯é€šè¿‡"
          echo "BUILD_STATUS=PASS" >> $GITHUB_ENV
        else
          echo "âŒ Go buildéªŒè¯å¤±è´¥"
          echo "BUILD_STATUS=FAIL" >> $GITHUB_ENV
        fi

    - name: ğŸ“¦ Go modéªŒè¯
      run: |
        echo "ğŸ“¦ æ‰§è¡ŒGo modéªŒè¯..."

        # éªŒè¯æ¨¡å—ä¾èµ–
        if go mod verify; then
          echo "âœ… Go modéªŒè¯é€šè¿‡"
          echo "MOD_STATUS=PASS" >> $GITHUB_ENV
        else
          echo "âŒ Go modéªŒè¯å¤±è´¥"
          echo "MOD_STATUS=FAIL" >> $GITHUB_ENV
        fi

    - name: ğŸ“Š Goå®˜æ–¹å·¥å…·éªŒè¯ç»“æœ
      run: |
        echo "=== Goå®˜æ–¹å·¥å…·éªŒè¯æ±‡æ€» ==="
        echo "Go vetçŠ¶æ€: $VET_STATUS"
        echo "Go buildçŠ¶æ€: $BUILD_STATUS"
        echo "Go modçŠ¶æ€: $MOD_STATUS"
        echo "========================="

        if [ "$VET_STATUS" != "PASS" ] || [ "$BUILD_STATUS" != "PASS" ] || [ "$MOD_STATUS" != "PASS" ]; then
          echo "ğŸ’¥ CIå¤±è´¥: Goå®˜æ–¹å·¥å…·éªŒè¯æœªé€šè¿‡"
          exit 1
        else
          echo "âœ… æ‰€æœ‰Goå®˜æ–¹å·¥å…·éªŒè¯é€šè¿‡"
        fi

  # ===== P2çº§åˆ«: ä¼ä¸šçº§ä»£ç è´¨é‡æ£€æŸ¥ =====
  code-quality-check:
    name: ğŸ“‹ P2-ä¼ä¸šçº§ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: go-official-validation
    timeout-minutes: 20

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”§ è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ“¦ å®‰è£…golangci-lint
      uses: golangci/golangci-lint-action@v6
      with:
        version: ${{ env.GOLANGCI_LINT_VERSION }}
        args: --timeout=10m --verbose
        skip-cache: false
        skip-save-cache: false

    - name: ğŸ” æ‰§è¡Œgolangci-lintæ£€æŸ¥
      continue-on-error: true
      run: |
        echo "ğŸ” æ‰§è¡Œgolangci-lintä¼ä¸šçº§è´¨é‡æ£€æŸ¥..."

        # åˆ›å»ºè´¨é‡æŠ¥å‘Šç›®å½•
        mkdir -p reports/quality

        # æ‰§è¡Œgolangci-lintæ£€æŸ¥
        golangci-lint run --out-format json | tee reports/quality/golangci-report.json
        golangci-lint run --out-format colored-line-number | tee reports/quality/golangci-report.txt

        # åˆ†ææ£€æŸ¥ç»“æœ
        if [ -f reports/quality/golangci-report.json ]; then
          ISSUE_COUNT=$(jq '.Issues | length' reports/quality/golangci-report.json 2>/dev/null || echo "0")
          echo "ğŸ“Š å‘ç°ä»£ç è´¨é‡é—®é¢˜æ•°é‡: $ISSUE_COUNT"
          echo "QUALITY_ISSUE_COUNT=$ISSUE_COUNT" >> $GITHUB_ENV

          if [ "$ISSUE_COUNT" = "0" ]; then
            echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œç¾é€šè¿‡"
            echo "QUALITY_STATUS=PERFECT" >> $GITHUB_ENV
          else
            echo "âš ï¸ å‘ç°ä»£ç è´¨é‡æ”¹è¿›ç‚¹: $ISSUE_COUNT ä¸ª"
            echo "QUALITY_STATUS=IMPROVEMENT_NEEDED" >> $GITHUB_ENV
          fi
        else
          echo "QUALITY_STATUS=UNKNOWN" >> $GITHUB_ENV
        fi

    - name: ğŸ“Š ä¸Šä¼ ä»£ç è´¨é‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: reports/quality/
        retention-days: 30

  # ===== P3çº§åˆ«: æµ‹è¯•å’Œæ€§èƒ½éªŒè¯ =====
  test-and-performance:
    name: ğŸ§ª P3-æµ‹è¯•è¦†ç›–ç‡å’Œæ€§èƒ½åŸºå‡†
    runs-on: ubuntu-latest
    needs: code-quality-check
    timeout-minutes: 15
    if: github.event.inputs.check_level == 'comprehensive' || github.event_name == 'schedule'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”§ è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ§ª æ‰§è¡Œæµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥
      run: |
        echo "ğŸ§ª æ‰§è¡Œæµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥..."

        # æŸ¥æ‰¾æµ‹è¯•æ–‡ä»¶
        TEST_FILES=$(find . -name "*_test.go" | wc -l)
        echo "ğŸ“‹ å‘ç°æµ‹è¯•æ–‡ä»¶æ•°é‡: $TEST_FILES"

        if [ "$TEST_FILES" -gt 0 ]; then
          # æ‰§è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
          go test -v -race -coverprofile=coverage.out ./... || true

          if [ -f coverage.out ]; then
            COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
            echo "ğŸ“Š æµ‹è¯•è¦†ç›–ç‡: $COVERAGE%"
            echo "TEST_COVERAGE=$COVERAGE" >> $GITHUB_ENV

            # ç”ŸæˆHTMLè¦†ç›–ç‡æŠ¥å‘Š
            go tool cover -html=coverage.out -o coverage.html
          else
            echo "âš ï¸ æ— æ³•ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"
            echo "TEST_COVERAGE=0" >> $GITHUB_ENV
          fi
        else
          echo "ğŸ“‹ æœªå‘ç°æµ‹è¯•æ–‡ä»¶ï¼Œè·³è¿‡æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥"
          echo "TEST_COVERAGE=N/A" >> $GITHUB_ENV
        fi

    - name: âš¡ æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
      run: |
        echo "âš¡ æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."

        # æŸ¥æ‰¾åŸºå‡†æµ‹è¯•
        BENCH_FILES=$(find . -name "*_test.go" -exec grep -l "func Benchmark" {} \; | wc -l)
        echo "ğŸ“‹ å‘ç°åŸºå‡†æµ‹è¯•æ–‡ä»¶æ•°é‡: $BENCH_FILES"

        if [ "$BENCH_FILES" -gt 0 ]; then
          go test -bench=. -benchmem ./... > benchmark.txt 2>&1 || true
          echo "ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ"
        else
          echo "ğŸ“‹ æœªå‘ç°åŸºå‡†æµ‹è¯•ï¼Œè·³è¿‡æ€§èƒ½æµ‹è¯•"
        fi

    - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-performance-reports
        path: |
          coverage.out
          coverage.html
          benchmark.txt
        retention-days: 30

  # ===== è´¨é‡æŠ¥å‘Šæ±‡æ€» =====
  quality-summary:
    name: ğŸ“Š è´¨é‡ä¿éšœæ±‡æ€»æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [security-scan, go-official-validation, code-quality-check]
    if: always()

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ“Š ç”Ÿæˆè´¨é‡ä¿éšœæ±‡æ€»æŠ¥å‘Š
      run: |
        echo "# ğŸ›¡ï¸ Go Mastery è´¨é‡ä¿éšœæŠ¥å‘Š" > quality-summary.md
        echo "**æ£€æŸ¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> quality-summary.md
        echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> quality-summary.md
        echo "**æäº¤**: ${{ github.sha }}" >> quality-summary.md
        echo "" >> quality-summary.md

        echo "## ğŸ”’ å®‰å…¨æ£€æŸ¥ç»“æœ" >> quality-summary.md
        echo "- **å®‰å…¨æ¼æ´æ‰«æ**: ${{ needs.security-scan.result }}" >> quality-summary.md
        echo "" >> quality-summary.md

        echo "## ğŸ”§ Goå®˜æ–¹å·¥å…·éªŒè¯" >> quality-summary.md
        echo "- **Go vetæ£€æŸ¥**: ${{ needs.go-official-validation.result }}" >> quality-summary.md
        echo "" >> quality-summary.md

        echo "## ğŸ“‹ ä»£ç è´¨é‡æ£€æŸ¥" >> quality-summary.md
        echo "- **golangci-lintæ£€æŸ¥**: ${{ needs.code-quality-check.result }}" >> quality-summary.md
        echo "" >> quality-summary.md

        echo "## ğŸ¯ è´¨é‡ä¿éšœçŠ¶æ€" >> quality-summary.md
        if [ "${{ needs.security-scan.result }}" = "success" ] && [ "${{ needs.go-official-validation.result }}" = "success" ]; then
          echo "âœ… **é›¶å®‰å…¨æ¼æ´çŠ¶æ€**: ç»´æŒæˆåŠŸ" >> quality-summary.md
          echo "ğŸ† **ä¼ä¸šçº§è´¨é‡æ ‡å‡†**: ç¬¦åˆè¦æ±‚" >> quality-summary.md
        else
          echo "âŒ **è´¨é‡æ ‡å‡†**: éœ€è¦ç«‹å³ä¿®å¤" >> quality-summary.md
        fi

        echo "" >> quality-summary.md
        echo "---" >> quality-summary.md
        echo "*æœ¬æŠ¥å‘Šç”± Go Mastery æ™ºèƒ½è´¨é‡ä¿éšœç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*" >> quality-summary.md

        # æ˜¾ç¤ºæŠ¥å‘Šå†…å®¹
        echo "=== è´¨é‡ä¿éšœæ±‡æ€»æŠ¥å‘Š ==="
        cat quality-summary.md
        echo "========================="

    - name: ğŸ“Š ä¸Šä¼ è´¨é‡æ±‡æ€»æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-summary-report
        path: quality-summary.md
        retention-days: 90

  # ===== å¤±è´¥æ—¶çš„ç´§æ€¥å“åº” =====
  emergency-response:
    name: ğŸš¨ è´¨é‡é€€åŒ–ç´§æ€¥å“åº”
    runs-on: ubuntu-latest
    needs: [security-scan, go-official-validation]
    if: failure()

    steps:
    - name: ğŸš¨ å‘é€è´¨é‡è­¦æŠ¥
      run: |
        echo "ğŸš¨ ===== è´¨é‡é€€åŒ–è­¦æŠ¥ ====="
        echo "é¡¹ç›®: Go Mastery"
        echo "åˆ†æ”¯: ${{ github.ref_name }}"
        echo "æäº¤: ${{ github.sha }}"
        echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "âŒ æ£€æµ‹åˆ°è´¨é‡é€€åŒ–ï¼Œé›¶å®‰å…¨æ¼æ´çŠ¶æ€å¯èƒ½å·²è¢«ç ´å"
        echo ""
        echo "ğŸ”§ ç´§æ€¥ä¿®å¤æ­¥éª¤:"
        echo "1. ç«‹å³åœæ­¢ç›¸å…³ä»£ç åˆå¹¶"
        echo "2. æ£€æŸ¥å®‰å…¨æ‰«æå’ŒGoå·¥å…·éªŒè¯ç»“æœ"
        echo "3. å‚è€ƒ COMPREHENSIVE_QUALITY_REPORT.md è¿›è¡Œä¿®å¤"
        echo "4. é‡æ–°è¿è¡Œè´¨é‡æ£€æŸ¥ç›´åˆ°é€šè¿‡"
        echo "=========================="

        # å¦‚æœé…ç½®äº†é€šçŸ¥webhookï¼Œå¯ä»¥åœ¨æ­¤å¤„å‘é€è­¦æŠ¥
        # curl -X POST $WEBHOOK_URL -d "payload"