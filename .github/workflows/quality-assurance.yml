# 馃洝锔?Go Mastery 椤圭洰 - 闆跺畨鍏ㄦ紡娲炶川閲忎繚闅?CI/CD 娴佹按绾?
# 璁捐鐩爣: 缁存姢浼佷笟绾ч浂瀹夊叏璀﹀憡鏍囧噯
# 鏈€鍚庢洿鏂? 2025骞?鏈?7鏃?

name: 馃敀 Quality Assurance - Zero Security Warnings

# 瑙﹀彂鏉′欢: 鍏ㄩ潰瑕嗙洊鎵€鏈夎川閲忕浉鍏充簨浠?
on:
  # 涓昏瑙﹀彂鏉′欢
  push:
    branches: [ main, develop, 'feature/*', 'security/*' ]
  pull_request:
    branches: [ main, develop ]

  # 瀹氭湡璐ㄩ噺妫€鏌?(姣忔棩UTC 02:00, 鍖椾含鏃堕棿10:00)
  schedule:
    - cron: '0 2 * * *'

  # 鎵嬪姩瑙﹀彂璐ㄩ噺妫€鏌?
  workflow_dispatch:
    inputs:
      check_level:
        description: '璐ㄩ噺妫€鏌ョ骇鍒?
        required: true
        default: 'standard'
        type: choice
        options:
        - quick
        - standard
        - comprehensive
        - security-focused

# 鐜鍙橀噺閰嶇疆
env:
  GO_VERSION: '1.24'
  GOLANGCI_LINT_VERSION: 'v1.64.8'
  GOSEC_VERSION: 'v2.21.4'

  # 璐ㄩ噺鏍囧噯闃堝€?
  SECURITY_VULNERABILITIES_THRESHOLD: 0  # 闆跺畨鍏ㄦ紡娲炶姹?
  GO_VET_WARNINGS_THRESHOLD: 0          # 闆禛o vet璀﹀憡瑕佹眰
  COVERAGE_THRESHOLD: 60                 # 娴嬭瘯瑕嗙洊鐜囨渶浣庤姹?

jobs:
  # ===== P0绾у埆: 瀹夊叏婕忔礊妫€娴?(鍏抽敭浠诲姟) =====
  security-scan:
    name: 馃洝锔?P0-瀹夊叏婕忔礊鎵弿 (闆舵紡娲炶姹?
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      GOSEC_TARGETS: "./common/... ./internal/..."

    steps:
    - name: 馃摜 妫€鍑轰唬鐮?
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 馃敡 璁剧疆Go鐜
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: 馃搵 Go鐜璇婃柇
      run: |
        echo "=== Go鐜淇℃伅 ==="
        go version
        go env GOROOT
        go env GOPATH
        echo "==================="

    - name: 馃摝 瀹夎gosec瀹夊叏鎵弿鍣?
      run: |
        go install github.com/securego/gosec/v2/cmd/gosec@${{ env.GOSEC_VERSION }}
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: 馃攳 鎵ц瀹夊叏婕忔礊鎵弿
      run: |
        echo "馃毃 寮€濮嬪畨鍏ㄦ紡娲炴壂鎻?.."

        # 鍒涘缓瀹夊叏鎵弿鎶ュ憡鐩綍
        mkdir -p reports/security

        # 鎵цgosec鎵弿 (JSON鏍煎紡杈撳嚭)
        gosec -fmt json -out reports/security/gosec-report.json ${GOSEC_TARGETS} || GOSEC_EXIT_CODE=$?

        # 鎵цgosec鎵弿 (鏂囨湰鏍煎紡杈撳嚭)
        gosec -fmt text -out reports/security/gosec-report.txt ${GOSEC_TARGETS} || true

        # 鍒嗘瀽鎵弿缁撴灉
        if [ -f reports/security/gosec-report.json ]; then
          VULNERABILITY_COUNT=$(jq '.Stats.found' reports/security/gosec-report.json 2>/dev/null || echo "unknown")
          echo "馃攳 鍙戠幇瀹夊叏婕忔礊鏁伴噺: $VULNERABILITY_COUNT"

          if [ "$VULNERABILITY_COUNT" = "0" ]; then
            echo "鉁?瀹夊叏鎵弿閫氳繃: 闆跺畨鍏ㄦ紡娲炵姸鎬佺淮鎸?
            echo "SECURITY_STATUS=PASS" >> $GITHUB_ENV
          elif [ "$VULNERABILITY_COUNT" != "unknown" ] && [ "$VULNERABILITY_COUNT" -gt 0 ]; then
            echo "鉂?瀹夊叏鎵弿澶辫触: 鍙戠幇 $VULNERABILITY_COUNT 涓畨鍏ㄦ紡娲?
            echo "SECURITY_STATUS=FAIL" >> $GITHUB_ENV
            echo "VULNERABILITY_COUNT=$VULNERABILITY_COUNT" >> $GITHUB_ENV

            # 杈撳嚭婕忔礊璇︽儏
            echo "=== 瀹夊叏婕忔礊璇︽儏 ==="
            cat reports/security/gosec-report.txt
            echo "====================="
          else
            echo "鈿狅笍 鏃犳硶瑙ｆ瀽瀹夊叏鎵弿缁撴灉"
            echo "SECURITY_STATUS=ERROR" >> $GITHUB_ENV
          fi
        else
          echo "鉂?瀹夊叏鎵弿鎶ュ憡鐢熸垚澶辫触"
          echo "SECURITY_STATUS=ERROR" >> $GITHUB_ENV
        fi

    - name: 馃搳 涓婁紶瀹夊叏鎵弿鎶ュ憡
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-reports
        path: reports/security/
        retention-days: 30

    - name: 馃攳 Go瀹樻柟婕忔礊鏁版嵁搴撴壂鎻?(govulncheck)
      run: |
        echo "馃攳 鎵цGo瀹樻柟婕忔礊鏁版嵁搴撴壂鎻?.."

        # 瀹夎govulncheck
        go install golang.org/x/vuln/cmd/govulncheck@latest

        # 鎵ц婕忔礊鎵弿
        echo "寮€濮嬫壂鎻忎緷璧栨紡娲?.."
        if govulncheck ./... > reports/security/govulncheck-report.txt 2>&1; then
          echo "鉁?govulncheck鎵弿閫氳繃: 鏈彂鐜板凡鐭ユ紡娲?
          echo "GOVULNCHECK_STATUS=PASS" >> $GITHUB_ENV
        else
          VULNCHECK_EXIT_CODE=$?
          echo "鈿狅笍 govulncheck鎵弿鍙戠幇娼滃湪闂"
          echo "=== govulncheck 鎶ュ憡 ==="
          cat reports/security/govulncheck-report.txt
          echo "======================="

          # 鏍规嵁閫€鍑虹爜鍒ゆ柇涓ラ噸绋嬪害
          if [ "$VULNCHECK_EXIT_CODE" -eq 3 ]; then
            echo "鉂?鍙戠幇褰卞搷浠ｇ爜鐨勫凡鐭ユ紡娲?
            echo "GOVULNCHECK_STATUS=FAIL" >> $GITHUB_ENV
          else
            echo "鈿狅笍 鍙戠幇鏈娇鐢ㄤ緷璧栦腑鐨勬紡娲烇紙褰卞搷杈冧綆锛?
            echo "GOVULNCHECK_STATUS=WARN" >> $GITHUB_ENV
          fi
        fi

    - name: 馃毃 瀹夊叏鎵弿缁撴灉楠岃瘉
      run: |
        echo "=== 瀹夊叏鎵弿姹囨€?==="
        echo "gosec鐘舵€? $SECURITY_STATUS"
        echo "govulncheck鐘舵€? $GOVULNCHECK_STATUS"
        echo "===================="

        if [ "$SECURITY_STATUS" = "FAIL" ]; then
          echo "馃挜 CI澶辫触: gosec妫€娴嬪埌瀹夊叏婕忔礊锛岃繚鍙嶉浂瀹夊叏婕忔礊瑕佹眰"
          echo "馃搵 璇风珛鍗充慨澶嶄互涓嬪畨鍏ㄦ紡娲?"
          echo "   1. 鏌ョ湅涓婁紶鐨勫畨鍏ㄦ壂鎻忔姤鍛?
          echo "   2. 鍙傝€?COMPREHENSIVE_QUALITY_REPORT.md 涓殑淇绛栫暐"
          echo "   3. 杩愯 golangci-lint run 杩涜鏈湴楠岃瘉"
          exit 1
        elif [ "$SECURITY_STATUS" = "ERROR" ]; then
          echo "鈿狅笍 CI璀﹀憡: gosec鎵弿杩囩▼鍑虹幇閿欒"
          exit 1
        elif [ "$GOVULNCHECK_STATUS" = "FAIL" ]; then
          echo "馃挜 CI澶辫触: govulncheck鍙戠幇褰卞搷浠ｇ爜鐨勫凡鐭ユ紡娲?
          echo "馃搵 璇风珛鍗虫洿鏂板彈褰卞搷鐨勪緷璧栨垨搴旂敤瀹夊叏琛ヤ竵"
          exit 1
        elif [ "$GOVULNCHECK_STATUS" = "WARN" ]; then
          echo "鈿狅笍 CI璀﹀憡: govulncheck鍙戠幇鏈娇鐢ㄤ緷璧栦腑鐨勬紡娲?
          echo "馃挕 寤鸿: 杩愯 go mod tidy 娓呯悊鏈娇鐢ㄧ殑渚濊禆"
          # 璀﹀憡涓嶉樆濉濩I锛屽厑璁哥户缁?
        else
          echo "鉁?鎵€鏈夊畨鍏ㄦ壂鎻忛€氳繃: 闆跺畨鍏ㄦ紡娲炵姸鎬佸凡缁存寔"
        fi

  # ===== P1绾у埆: Go瀹樻柟宸ュ叿楠岃瘉 =====
  go-official-validation:
    name: 馃敡 P1-Go瀹樻柟宸ュ叿楠岃瘉
    runs-on: ubuntu-latest
    needs: security-scan
    timeout-minutes: 10

    steps:
    - name: 馃摜 妫€鍑轰唬鐮?
      uses: actions/checkout@v4

    - name: 馃敡 璁剧疆Go鐜
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: 馃攳 Go vet妫€鏌?
      run: |
        echo "馃攳 鎵цGo vet妫€鏌?.."
        go vet ./... 2>&1 | tee vet-output.txt

        if [ -s vet-output.txt ]; then
          echo "鉂?Go vet妫€鏌ュけ璐?
          echo "VET_STATUS=FAIL" >> $GITHUB_ENV
          echo "=== Go vet 璀﹀憡璇︽儏 ==="
          cat vet-output.txt
          echo "======================="
        else
          echo "鉁?Go vet妫€鏌ラ€氳繃"
          echo "VET_STATUS=PASS" >> $GITHUB_ENV
        fi

    - name: 馃彈锔?Go build楠岃瘉
      run: |
        echo "馃彈锔?鎵цGo build楠岃瘉..."

        # 灏濊瘯鏋勫缓鎵€鏈夊寘
        if go build ./...; then
          echo "鉁?Go build楠岃瘉閫氳繃"
          echo "BUILD_STATUS=PASS" >> $GITHUB_ENV
        else
          echo "鉂?Go build楠岃瘉澶辫触"
          echo "BUILD_STATUS=FAIL" >> $GITHUB_ENV
        fi

    - name: 馃摝 Go mod楠岃瘉
      run: |
        echo "馃摝 鎵цGo mod楠岃瘉..."

        # 楠岃瘉妯″潡渚濊禆
        if go mod verify; then
          echo "鉁?Go mod楠岃瘉閫氳繃"
          echo "MOD_STATUS=PASS" >> $GITHUB_ENV
        else
          echo "鉂?Go mod楠岃瘉澶辫触"
          echo "MOD_STATUS=FAIL" >> $GITHUB_ENV
        fi

    - name: 馃搳 Go瀹樻柟宸ュ叿楠岃瘉缁撴灉
      run: |
        echo "=== Go瀹樻柟宸ュ叿楠岃瘉姹囨€?==="
        echo "Go vet鐘舵€? $VET_STATUS"
        echo "Go build鐘舵€? $BUILD_STATUS"
        echo "Go mod鐘舵€? $MOD_STATUS"
        echo "========================="

        if [ "$VET_STATUS" != "PASS" ] || [ "$BUILD_STATUS" != "PASS" ] || [ "$MOD_STATUS" != "PASS" ]; then
          echo "馃挜 CI澶辫触: Go瀹樻柟宸ュ叿楠岃瘉鏈€氳繃"
          exit 1
        else
          echo "鉁?鎵€鏈塆o瀹樻柟宸ュ叿楠岃瘉閫氳繃"
        fi

  # ===== P2绾у埆: 浼佷笟绾т唬鐮佽川閲忔鏌?=====
  code-quality-check:
    name: 馃搵 P2-浼佷笟绾т唬鐮佽川閲忔鏌?
    runs-on: ubuntu-latest
    needs: go-official-validation
    timeout-minutes: 20

    steps:
    - name: 馃摜 妫€鍑轰唬鐮?
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 馃敡 璁剧疆Go鐜
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: 馃摝 瀹夎golangci-lint
      uses: golangci/golangci-lint-action@v6
      with:
        version: ${{ env.GOLANGCI_LINT_VERSION }}
        args: --timeout=10m --verbose
        skip-cache: false
        skip-save-cache: false

    - name: 馃攳 鎵цgolangci-lint妫€鏌?
      continue-on-error: true
      run: |
        echo "馃攳 鎵цgolangci-lint浼佷笟绾ц川閲忔鏌?.."

        # 鍒涘缓璐ㄩ噺鎶ュ憡鐩綍
        mkdir -p reports/quality

        # 鎵цgolangci-lint妫€鏌?
        golangci-lint run --out-format json | tee reports/quality/golangci-report.json
        golangci-lint run --out-format colored-line-number | tee reports/quality/golangci-report.txt

        # 鍒嗘瀽妫€鏌ョ粨鏋?
        if [ -f reports/quality/golangci-report.json ]; then
          ISSUE_COUNT=$(jq '.Issues | length' reports/quality/golangci-report.json 2>/dev/null || echo "0")
          echo "馃搳 鍙戠幇浠ｇ爜璐ㄩ噺闂鏁伴噺: $ISSUE_COUNT"
          echo "QUALITY_ISSUE_COUNT=$ISSUE_COUNT" >> $GITHUB_ENV

          if [ "$ISSUE_COUNT" = "0" ]; then
            echo "鉁?浠ｇ爜璐ㄩ噺妫€鏌ュ畬缇庨€氳繃"
            echo "QUALITY_STATUS=PERFECT" >> $GITHUB_ENV
          else
            echo "鈿狅笍 鍙戠幇浠ｇ爜璐ㄩ噺鏀硅繘鐐? $ISSUE_COUNT 涓?
            echo "QUALITY_STATUS=IMPROVEMENT_NEEDED" >> $GITHUB_ENV
          fi
        else
          echo "QUALITY_STATUS=UNKNOWN" >> $GITHUB_ENV
        fi

    - name: 馃搳 涓婁紶浠ｇ爜璐ㄩ噺鎶ュ憡
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: reports/quality/
        retention-days: 30

  # ===== P3绾у埆: 娴嬭瘯鍜屾€ц兘楠岃瘉 =====
  test-and-performance:
    name: 馃И P3-娴嬭瘯瑕嗙洊鐜囧拰鎬ц兘鍩哄噯
    runs-on: ubuntu-latest
    needs: code-quality-check
    timeout-minutes: 15
    if: github.event.inputs.check_level == 'comprehensive' || github.event_name == 'schedule'

    steps:
    - name: 馃摜 妫€鍑轰唬鐮?
      uses: actions/checkout@v4

    - name: 馃敡 璁剧疆Go鐜
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: 馃И 鎵ц娴嬭瘯瑕嗙洊鐜囨鏌?
      run: |
        echo "馃И 鎵ц娴嬭瘯瑕嗙洊鐜囨鏌?.."

        # 鏌ユ壘娴嬭瘯鏂囦欢
        TEST_FILES=$(find . -name "*_test.go" | wc -l)
        echo "馃搵 鍙戠幇娴嬭瘯鏂囦欢鏁伴噺: $TEST_FILES"

        if [ "$TEST_FILES" -gt 0 ]; then
          # 鎵ц娴嬭瘯骞剁敓鎴愯鐩栫巼鎶ュ憡
          go test -v -race -coverprofile=coverage.out ./... || true

          if [ -f coverage.out ]; then
            COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
            echo "馃搳 娴嬭瘯瑕嗙洊鐜? $COVERAGE%"
            echo "TEST_COVERAGE=$COVERAGE" >> $GITHUB_ENV

            # 鐢熸垚HTML瑕嗙洊鐜囨姤鍛?
            go tool cover -html=coverage.out -o coverage.html
          else
            echo "鈿狅笍 鏃犳硶鐢熸垚瑕嗙洊鐜囨姤鍛?
            echo "TEST_COVERAGE=0" >> $GITHUB_ENV
          fi
        else
          echo "馃搵 鏈彂鐜版祴璇曟枃浠讹紝璺宠繃娴嬭瘯瑕嗙洊鐜囨鏌?
          echo "TEST_COVERAGE=N/A" >> $GITHUB_ENV
        fi

    - name: 鈿?鎵ц鎬ц兘鍩哄噯娴嬭瘯
      run: |
        echo "鈿?鎵ц鎬ц兘鍩哄噯娴嬭瘯..."

        # 鏌ユ壘鍩哄噯娴嬭瘯
        BENCH_FILES=$(find . -name "*_test.go" -exec grep -l "func Benchmark" {} \; | wc -l)
        echo "馃搵 鍙戠幇鍩哄噯娴嬭瘯鏂囦欢鏁伴噺: $BENCH_FILES"

        if [ "$BENCH_FILES" -gt 0 ]; then
          go test -bench=. -benchmem ./... > benchmark.txt 2>&1 || true
          echo "馃搳 鎬ц兘鍩哄噯娴嬭瘯瀹屾垚"
        else
          echo "馃搵 鏈彂鐜板熀鍑嗘祴璇曪紝璺宠繃鎬ц兘娴嬭瘯"
        fi

    - name: 馃搳 涓婁紶娴嬭瘯鎶ュ憡
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-performance-reports
        path: |
          coverage.out
          coverage.html
          benchmark.txt
        retention-days: 30

  # ===== 璐ㄩ噺鎶ュ憡姹囨€?=====
  quality-summary:
    name: 馃搳 璐ㄩ噺淇濋殰姹囨€绘姤鍛?
    runs-on: ubuntu-latest
    needs: [security-scan, go-official-validation, code-quality-check]
    if: always()

    steps:
    - name: 馃摜 妫€鍑轰唬鐮?
      uses: actions/checkout@v4

    - name: 馃搳 鐢熸垚璐ㄩ噺淇濋殰姹囨€绘姤鍛?
      run: |
        echo "# 馃洝锔?Go Mastery 璐ㄩ噺淇濋殰鎶ュ憡" > quality-summary.md
        echo "**妫€鏌ユ椂闂?*: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> quality-summary.md
        echo "**鍒嗘敮**: ${{ github.ref_name }}" >> quality-summary.md
        echo "**鎻愪氦**: ${{ github.sha }}" >> quality-summary.md
        echo "" >> quality-summary.md

        echo "## 馃敀 瀹夊叏妫€鏌ョ粨鏋? >> quality-summary.md
        echo "- **瀹夊叏婕忔礊鎵弿**: ${{ needs.security-scan.result }}" >> quality-summary.md
        echo "" >> quality-summary.md

        echo "## 馃敡 Go瀹樻柟宸ュ叿楠岃瘉" >> quality-summary.md
        echo "- **Go vet妫€鏌?*: ${{ needs.go-official-validation.result }}" >> quality-summary.md
        echo "" >> quality-summary.md

        echo "## 馃搵 浠ｇ爜璐ㄩ噺妫€鏌? >> quality-summary.md
        echo "- **golangci-lint妫€鏌?*: ${{ needs.code-quality-check.result }}" >> quality-summary.md
        echo "" >> quality-summary.md

        echo "## 馃幆 璐ㄩ噺淇濋殰鐘舵€? >> quality-summary.md
        if [ "${{ needs.security-scan.result }}" = "success" ] && [ "${{ needs.go-official-validation.result }}" = "success" ]; then
          echo "鉁?**闆跺畨鍏ㄦ紡娲炵姸鎬?*: 缁存寔鎴愬姛" >> quality-summary.md
          echo "馃弳 **浼佷笟绾ц川閲忔爣鍑?*: 绗﹀悎瑕佹眰" >> quality-summary.md
        else
          echo "鉂?**璐ㄩ噺鏍囧噯**: 闇€瑕佺珛鍗充慨澶? >> quality-summary.md
        fi

        echo "" >> quality-summary.md
        echo "---" >> quality-summary.md
        echo "*鏈姤鍛婄敱 Go Mastery 鏅鸿兘璐ㄩ噺淇濋殰绯荤粺鑷姩鐢熸垚*" >> quality-summary.md

        # 鏄剧ず鎶ュ憡鍐呭
        echo "=== 璐ㄩ噺淇濋殰姹囨€绘姤鍛?==="
        cat quality-summary.md
        echo "========================="

    - name: 馃搳 涓婁紶璐ㄩ噺姹囨€绘姤鍛?
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-summary-report
        path: quality-summary.md
        retention-days: 90

  # ===== 澶辫触鏃剁殑绱ф€ュ搷搴?=====
  emergency-response:
    name: 馃毃 璐ㄩ噺閫€鍖栫揣鎬ュ搷搴?
    runs-on: ubuntu-latest
    needs: [security-scan, go-official-validation]
    if: failure()

    steps:
    - name: 馃毃 鍙戦€佽川閲忚鎶?
      run: |
        echo "馃毃 ===== 璐ㄩ噺閫€鍖栬鎶?====="
        echo "椤圭洰: Go Mastery"
        echo "鍒嗘敮: ${{ github.ref_name }}"
        echo "鎻愪氦: ${{ github.sha }}"
        echo "鏃堕棿: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "鉂?妫€娴嬪埌璐ㄩ噺閫€鍖栵紝闆跺畨鍏ㄦ紡娲炵姸鎬佸彲鑳藉凡琚牬鍧?
        echo ""
        echo "馃敡 绱ф€ヤ慨澶嶆楠?"
        echo "1. 绔嬪嵆鍋滄鐩稿叧浠ｇ爜鍚堝苟"
        echo "2. 妫€鏌ュ畨鍏ㄦ壂鎻忓拰Go宸ュ叿楠岃瘉缁撴灉"
        echo "3. 鍙傝€?COMPREHENSIVE_QUALITY_REPORT.md 杩涜淇"
        echo "4. 閲嶆柊杩愯璐ㄩ噺妫€鏌ョ洿鍒伴€氳繃"
        echo "=========================="

        # 濡傛灉閰嶇疆浜嗛€氱煡webhook锛屽彲浠ュ湪姝ゅ鍙戦€佽鎶?
        # curl -X POST $WEBHOOK_URL -d "payload"


